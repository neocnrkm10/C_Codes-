<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NULLCHAT // V3</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Syncopate:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #00f0ff;
      --secondary: #7000ff;
      --accent: #ff0055;
      --bg-dark: #050508;
      --glass: rgba(10, 10, 16, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text: #e0e0e0;
      --font-main: 'Space Grotesk', sans-serif;
      --font-head: 'Syncopate', sans-serif;
    }

    /* --- BASE --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      background: var(--bg-dark);
      color: var(--text);
      font-family: var(--font-main);
      height: 100vh; width: 100vw;
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* --- 3D BACKGROUND --- */
    #canvas-container {
      position: fixed; inset: 0; z-index: -1;
      opacity: 0.8; 
    }

    /* --- UI STRUCTURE --- */
    header {
      padding: 15px 20px;
      background: rgba(5, 5, 8, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--glass-border);
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .brand { font-family: var(--font-head); font-size: 1.2rem; letter-spacing: 2px; }
    .brand span { color: var(--primary); text-shadow: 0 0 15px var(--primary); }

    /* CHAT AREA */
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15px;
      display: flex; flex-direction: column; gap: 15px;
      scroll-behavior: smooth;
    }
    #chat-container::-webkit-scrollbar { width: 4px; }
    #chat-container::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }

    /* MESSAGES */
    .msg-group { display: flex; flex-direction: column; max-width: 85%; position: relative; animation: slideUp 0.3s ease-out; }
    .msg-group.self { align-self: flex-end; align-items: flex-end; }
    
    .msg-sender { font-size: 0.65rem; color: var(--primary); margin-bottom: 4px; opacity: 0.8; letter-spacing: 1px; font-weight: bold; }
    
    .msg-bubble {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      padding: 10px 14px;
      border-radius: 12px;
      border-top-left-radius: 2px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .self .msg-bubble {
      background: linear-gradient(135deg, rgba(112, 0, 255, 0.25), rgba(5, 5, 8, 0.9));
      border-color: rgba(112, 0, 255, 0.5);
      border-radius: 12px;
      border-top-right-radius: 2px;
    }
    
    /* Pending (Optimistic UI) */
    .msg-group.pending { opacity: 0.6; }

    /* Attachments */
    .msg-img { max-width: 100%; border-radius: 8px; margin-top: 8px; border: 1px solid var(--glass-border); cursor: zoom-in; }
    .msg-audio { width: 100%; min-width: 220px; height: 35px; margin-top: 5px; border-radius: 20px; }

    /* REACTIONS ROW */
    .reactions-row {
      display: flex; gap: 5px; flex-wrap: wrap; margin-top: -5px; margin-bottom: 5px; z-index: 2;
      transform: translateY(50%); 
    }
    .self .reactions-row { justify-content: flex-end; }

    .reaction-pill {
      background: #1a1a24;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.7rem;
      display: flex; align-items: center; gap: 3px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .reaction-pill span { color: #fff; }

    /* --- INPUT AREA --- */
    .input-zone {
      padding: 10px 15px;
      background: rgba(5, 5, 8, 0.95);
      border-top: 1px solid var(--glass-border);
    }
    
    #reply-bar {
      display: none; background: rgba(0, 240, 255, 0.1);
      border-left: 2px solid var(--primary); padding: 6px 12px;
      margin-bottom: 8px; font-size: 0.8rem; justify-content: space-between;
      border-radius: 4px; color: var(--primary);
    }

    .input-wrapper {
      display: flex; align-items: flex-end; gap: 10px;
      background: rgba(255,255,255,0.04); border-radius: 24px;
      padding: 10px 14px; border: 1px solid var(--glass-border);
    }

    #msg-input {
      flex: 1; background: transparent; border: none; color: #fff;
      font-family: var(--font-main); font-size: 1rem;
      max-height: 100px; resize: none; outline: none; padding: 4px 0;
    }

    .action-btn {
      color: var(--text); background: transparent; border: none;
      font-size: 1.3rem; padding: 5px; cursor: pointer; transition: 0.2s;
    }
    .action-btn:hover { color: var(--primary); text-shadow: 0 0 8px var(--primary); }
    .send-btn { color: var(--primary); }
    .record-btn.recording { color: var(--accent); animation: pulseRed 1s infinite; }

    /* --- MENUS & MODALS --- */
    #context-menu {
      position: fixed; display: none; z-index: 1000;
      background: rgba(15, 15, 20, 0.98); border: 1px solid var(--glass-border);
      border-radius: 12px; overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      min-width: 160px;
    }
    .ctx-reactions { display: flex; justify-content: space-around; padding: 12px 8px; background: rgba(255,255,255,0.03); border-bottom: 1px solid #333; }
    .ctx-emoji { font-size: 1.4rem; cursor: pointer; transition: transform 0.1s; }
    .ctx-emoji:hover { transform: scale(1.3); }
    
    .ctx-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .ctx-item:hover { background: rgba(0, 240, 255, 0.1); color: var(--primary); }

    /* PREVIEW MODAL */
    #preview-modal {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,0.95);
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .preview-box {
      background: #111; border: 1px solid var(--primary);
      padding: 20px; border-radius: 12px; text-align: center;
      max-width: 90%; width: 350px;
    }
    .preview-content { max-width: 100%; max-height: 50vh; margin: 15px 0; border-radius: 8px; }
    .preview-btns { display: flex; gap: 10px; justify-content: center; }
    .p-btn { flex: 1; padding: 12px; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; }
    .p-cancel { background: #333; color: #fff; }
    .p-send { background: var(--primary); color: #000; }

    /* LOGIN */
    #login-screen {
      position: fixed; inset: 0; z-index: 200; background: #000;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
    }
    .glitch-text { font-family: var(--font-head); font-size: 3rem; color: var(--primary); text-shadow: 3px 3px var(--secondary); margin-bottom: 30px; }
    .login-box { display: flex; gap: 10px; width: 300px; }
    .login-input { flex: 1; padding: 12px; background: #0a0a0f; border: 1px solid #333; color: #fff; outline: none; border-radius: 6px; }
    .login-btn { padding: 12px 20px; background: var(--primary); border: none; font-weight: bold; cursor: pointer; border-radius: 6px; }
    
    .credits {
      position: absolute; bottom: 30px;
      font-family: var(--font-head); font-size: 0.7rem; 
      color: #555; letter-spacing: 2px;
      text-transform: uppercase;
      border-top: 1px solid #222; padding-top: 10px;
    }
    .credits span { color: var(--secondary); }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    
    input[type="file"] { display: none; }
  </style>
</head>
<body>

  <div id="canvas-container"></div>

  <div id="login-screen">
    <div class="glitch-text">NULLCHAT</div>
    <div class="login-box">
      <input type="text" id="username" class="login-input" placeholder="CODENAME" autocomplete="off">
      <button class="login-btn" onclick="joinChat()">ENTER</button>
    </div>
    <div class="credits">Created by <span>CNR Krishna Khanal</span></div>
  </div>

  <div id="preview-modal">
    <div class="preview-box">
      <h3 style="margin:0; color:var(--primary)">CONFIRM UPLOAD</h3>
      <div id="preview-container"></div>
      <div class="preview-btns">
        <button class="p-btn p-cancel" onclick="closePreview()">DISCARD</button>
        <button class="p-btn p-send" id="confirm-send-btn">SEND</button>
      </div>
    </div>
  </div>

  <header>
    <div class="brand">NULL<span>CHAT</span></div>
    <div id="status-indicator" style="font-size: 0.75rem; color: #555;">OFFLINE</div>
  </header>

  <div id="chat-container"></div>

  <div class="input-zone">
    <div id="reply-bar">
      <span>Replying to <b id="reply-to-user">User</b></span>
      <i class="ri-close-line" onclick="cancelReply()" style="cursor:pointer"></i>
    </div>

    <div class="input-wrapper">
      <input type="file" id="file-input" accept="image/*">
      <button class="action-btn" onclick="document.getElementById('file-input').click()">
        <i class="ri-image-add-line"></i>
      </button>
      
      <button class="action-btn record-btn" id="mic-btn">
        <i class="ri-mic-2-line"></i>
      </button>

      <textarea id="msg-input" rows="1" placeholder="Broadcast to void..."></textarea>
      
      <button class="action-btn send-btn" onclick="handleTextSend()">
        <i class="ri-send-plane-2-fill"></i>
      </button>
    </div>
  </div>

  <div id="context-menu">
    <div class="ctx-reactions">
      <span class="ctx-emoji" onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="ctx-emoji" onclick="react('üòÇ')">üòÇ</span>
      <span class="ctx-emoji" onclick="react('üî•')">üî•</span>
      <span class="ctx-emoji" onclick="react('üëç')">üëç</span>
      <span class="ctx-emoji" onclick="react('üíÄ')">üíÄ</span>
    </div>
    <div class="ctx-item" onclick="initReply()">
      <i class="ri-reply-fill"></i> Reply
    </div>
    <div class="ctx-item" onclick="copyText()">
      <i class="ri-file-copy-fill"></i> Copy Text
    </div>
  </div>

  <script>
    // --- SUPABASE CONFIG ---
    // (Ensure you have a bucket named 'chat-files' set to Public)
    const SB_URL = 'https://lggbwtlpfbhwtzsitgmm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZ2J3dGxwZmJod3R6c2l0Z21tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjI3OTgsImV4cCI6MjA4NDQ5ODc5OH0.oD1m87laCi5vxnvWcYpN3v_BKfbDOvfll0omUORzEW4';
    const BUCKET = 'chat-files'; 
    const db = supabase.createClient(SB_URL, SB_KEY);

    // --- STATE ---
    let currentUser = null;
    let replyTo = null;
    let selectedMsgId = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let pendingBlob = null;
    let pendingType = null;
    let currentMessages = []; // Local cache for reactions updates

    // --- THREE.JS GALAXY BACKGROUND ---
    function initThreeJS() {
      const container = document.getElementById('canvas-container');
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      // 1. Moving Stars (Warp Speed Effect)
      const starsGeo = new THREE.BufferGeometry();
      const starsCount = 4000;
      const posArray = new Float32Array(starsCount * 3);
      const velocityArray = new Float32Array(starsCount);

      for(let i=0; i<starsCount; i++) {
        posArray[i*3] = (Math.random() - 0.5) * 600; // X
        posArray[i*3+1] = (Math.random() - 0.5) * 600; // Y
        posArray[i*3+2] = (Math.random() - 0.5) * 600; // Z
        velocityArray[i] = 0.2 + Math.random() * 0.5;
      }
      starsGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
      const starsMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.6, transparent:true, opacity:0.8 });
      const starField = new THREE.Points(starsGeo, starsMat);
      scene.add(starField);

      // 2. Central Cyber Core (Rotating Wireframe)
      const coreGeo = new THREE.IcosahedronGeometry(15, 1);
      const coreMat = new THREE.MeshBasicMaterial({ color: 0x00f0ff, wireframe: true, transparent:true, opacity:0.15 });
      const core = new THREE.Mesh(coreGeo, coreMat);
      scene.add(core);

      camera.position.z = 200;

      // Animation Loop
      function animate() {
        requestAnimationFrame(animate);
        
        // Rotate Core
        core.rotation.x += 0.001;
        core.rotation.y += 0.002;

        // Move Stars towards Camera
        const positions = starField.geometry.attributes.position.array;
        for(let i=0; i<starsCount; i++) {
          positions[i*3+2] += velocityArray[i] * 2; // Move Z forward
          
          if(positions[i*3+2] > 200) { // Reset if passed camera
            positions[i*3+2] = -400;
            positions[i*3] = (Math.random() - 0.5) * 600;
            positions[i*3+1] = (Math.random() - 0.5) * 600;
          }
        }
        starField.geometry.attributes.position.needsUpdate = true;
        renderer.render(scene, camera);
      }
      animate();

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    window.onload = initThreeJS;

    // --- AUTH & SETUP ---
    async function joinChat() {
      const username = document.getElementById('username').value.trim();
      if (!username) return alert("Codename required.");

      const btn = document.querySelector('.login-btn');
      btn.innerText = "CONNECTING...";

      const { data, error } = await db.auth.signInAnonymously();
      if (error) return alert("Connection Failed");

      currentUser = data.user;
      
      // Upsert Profile
      await db.from('profiles').upsert({ id: currentUser.id, username });

      // Save to localStorage
      localStorage.setItem('nc_user', JSON.stringify({id: currentUser.id, username}));

      // UI Transition
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('status-indicator').innerHTML = '<span style="color:#00f0ff">‚óè ONLINE</span>';
      
      loadMessages();
      subscribeRealtime();
    }

    // --- MESSAGING LOGIC ---
    async function loadMessages() {
      // 1. Load from Local (Instant)
      const cached = localStorage.getItem('nc_messages_v3');
      if (cached) {
        currentMessages = JSON.parse(cached);
        renderChat();
      }

      // 2. Fetch from Server (Sync)
      const { data } = await db.from('messages')
        .select(`
          *,
          profiles(username),
          reactions(emoji, user_id),
          reply_parent:messages!reply_to_id(content, profiles(username))
        `)
        .order('created_at', { ascending: false })
        .limit(50);

      if (data) {
        currentMessages = data.reverse();
        localStorage.setItem('nc_messages_v3', JSON.stringify(currentMessages));
        renderChat();
      }
    }

    function renderChat() {
      const container = document.getElementById('chat-container');
      container.innerHTML = '';
      currentMessages.forEach(msg => {
        container.appendChild(createMessageElement(msg));
      });
      scrollToBottom();
    }

    function createMessageElement(msg) {
      const isSelf = msg.user_id === currentUser.id;
      const div = document.createElement('div');
      div.className = `msg-group ${isSelf ? 'self' : ''}`;
      div.id = `msg-${msg.id}`;
      div.dataset.content = msg.content || "";
      div.dataset.username = msg.profiles?.username || "Unknown";

      // Context Menu Triggers
      div.addEventListener('contextmenu', (e) => showContextMenu(e, msg.id));
      let pressTimer;
      div.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => showContextMenu(e, msg.id, true), 600);
      });
      div.addEventListener('touchend', () => clearTimeout(pressTimer));

      let contentHtml = '';
      
      // Reply
      if (msg.reply_parent) {
        contentHtml += `
          <div style="font-size:0.7rem; color:var(--text); opacity:0.6; border-left:2px solid var(--accent); padding-left:6px; margin-bottom:6px;">
            Reply to: ${msg.reply_parent.profiles?.username || 'Unknown'}
          </div>`;
      }

      // Content
      if (msg.content) contentHtml += `<span>${escapeHtml(msg.content)}</span>`;
      
      // Attachments
      if (msg.attachment_type === 'image') {
        contentHtml += `<img src="${msg.attachment_url}" class="msg-img" onclick="window.open(this.src)">`;
      } else if (msg.attachment_type === 'audio') {
        contentHtml += `<audio src="${msg.attachment_url}" controls class="msg-audio"></audio>`;
      }

      // Reactions Display
      let reactionsHtml = '';
      if (msg.reactions && msg.reactions.length > 0) {
        const counts = {};
        msg.reactions.forEach(r => { counts[r.emoji] = (counts[r.emoji] || 0) + 1; });
        reactionsHtml = `<div class="reactions-row">`;
        for (const [emoji, count] of Object.entries(counts)) {
          reactionsHtml += `<div class="reaction-pill"><span>${emoji}</span><span>${count}</span></div>`;
        }
        reactionsHtml += `</div>`;
      }

      div.innerHTML = `
        <div class="msg-sender">${isSelf ? 'YOU' : (msg.profiles?.username || 'USER')}</div>
        <div class="msg-bubble">
          ${contentHtml}
        </div>
        ${reactionsHtml}
      `;
      return div;
    }

    // --- SENDING ---
    async function handleTextSend() {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (!text) return;

      // Optimistic Update
      const tempMsg = {
        id: 'temp-'+Date.now(),
        user_id: currentUser.id,
        content: text,
        created_at: new Date().toISOString(),
        profiles: { username: 'YOU' },
        reactions: [],
        reply_parent: replyTo ? { profiles: {username: replyTo.username} } : null
      };
      
      currentMessages.push(tempMsg);
      renderChat();
      
      input.value = '';
      const replyId = replyTo ? replyTo.id : null;
      cancelReply();

      // DB Insert
      await db.from('messages').insert({
        user_id: currentUser.id,
        content: text,
        reply_to_id: replyId
      });
      // Realtime will catch the real message and replace temp eventually
    }

    // --- REALTIME SUBSCRIPTION ---
    function subscribeRealtime() {
      db.channel('public:chat')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
          loadMessages(); // Refresh on new message
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'reactions' }, () => {
          loadMessages(); // Refresh on reaction
        })
        .subscribe();
    }

    // --- REACTION LOGIC ---
    async function react(emoji) {
      if (!selectedMsgId) return;
      document.getElementById('context-menu').style.display = 'none';

      // 1. Optimistic Update
      const msg = currentMessages.find(m => m.id === selectedMsgId);
      if (msg) {
        if (!msg.reactions) msg.reactions = [];
        // Simple optimistic add (deduplication happens on server usually, but we fake it here)
        msg.reactions.push({ emoji, user_id: currentUser.id }); 
        renderChat();
      }

      // 2. DB Insert
      // Note: Your SQL has a UNIQUE constraint. If duplicate, this errors, which is fine (prevents double react)
      await db.from('reactions').insert({
        message_id: selectedMsgId,
        user_id: currentUser.id,
        emoji: emoji
      });
      
      // Load messages will sync everything correctly shortly
      loadMessages();
    }

    // --- FILE & AUDIO HANDLING ---
    // Image
    document.getElementById('file-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        pendingBlob = file;
        pendingType = 'image';
        const reader = new FileReader();
        reader.onload = (ev) => showPreview(`<img src="${ev.target.result}" class="preview-content">`);
        reader.readAsDataURL(file);
      }
    });

    // Audio
    const micBtn = document.getElementById('mic-btn');
    micBtn.addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = () => {
            pendingBlob = new Blob(audioChunks, { type: 'audio/webm' });
            pendingType = 'audio';
            const url = URL.createObjectURL(pendingBlob);
            showPreview(`<audio src="${url}" controls class="preview-content" style="width:100%"></audio>`);
            micBtn.classList.remove('recording');
          };
          mediaRecorder.start();
          micBtn.classList.add('recording');
        } catch (e) { alert("Mic Error"); }
      } else {
        mediaRecorder.stop();
      }
    });

    function showPreview(html) {
      document.getElementById('preview-container').innerHTML = html;
      document.getElementById('preview-modal').style.display = 'flex';
    }
    
    function closePreview() {
      document.getElementById('preview-modal').style.display = 'none';
      pendingBlob = null;
    }

    document.getElementById('confirm-send-btn').addEventListener('click', async () => {
      if(!pendingBlob) return;
      const btn = document.getElementById('confirm-send-btn');
      btn.innerText = "SENDING...";
      
      const fileName = `${currentUser.id}/${Date.now()}`;
      const { error } = await db.storage.from(BUCKET).upload(fileName, pendingBlob);
      
      if(!error) {
        const { data: { publicUrl } } = db.storage.from(BUCKET).getPublicUrl(fileName);
        await db.from('messages').insert({
          user_id: currentUser.id,
          content: null,
          attachment_url: publicUrl,
          attachment_type: pendingType
        });
      }
      closePreview();
      btn.innerText = "SEND";
    });

    // --- HELPERS ---
    function showContextMenu(e, id, isTouch) {
      e.preventDefault();
      selectedMsgId = id;
      const menu = document.getElementById('context-menu');
      let x = isTouch ? e.touches[0].clientX : e.clientX;
      let y = isTouch ? e.touches[0].clientY : e.clientY;
      
      // Bounds check
      if (x + 160 > window.innerWidth) x = window.innerWidth - 170;
      if (y + 150 > window.innerHeight) y = window.innerHeight - 160;

      menu.style.display = 'block';
      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
      
      const close = () => { menu.style.display = 'none'; document.removeEventListener('click', close); };
      setTimeout(() => document.addEventListener('click', close), 100);
    }

    function initReply() {
      const el = document.getElementById(`msg-${selectedMsgId}`);
      replyTo = { id: selectedMsgId, username: el.dataset.username };
      document.getElementById('reply-to-user').innerText = replyTo.username;
      document.getElementById('reply-bar').style.display = 'flex';
      document.getElementById('msg-input').focus();
    }
    
    function cancelReply() {
      replyTo = null;
      document.getElementById('reply-bar').style.display = 'none';
    }

    function copyText() {
      const el = document.getElementById(`msg-${selectedMsgId}`);
      if(el) navigator.clipboard.writeText(el.dataset.content);
    }
    
    function escapeHtml(text) {
      return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : text;
    }

    function scrollToBottom() {
      const c = document.getElementById('chat-container');
      setTimeout(() => c.scrollTop = c.scrollHeight, 100);
    }
  </script>
</body>
</html>
