<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NULLCHAT // VOID_EDITION</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=JetBrains+Mono:wght@300;500;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #00f2ff;
      --accent: #7000ff;
      --danger: #ff4b2b;
      --success: #00ff9d;
      --bg: #030305;
      --glass: rgba(15, 15, 25, 0.7);
      --glass-bright: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.1);
      --text: #ffffff;
      --font-main: 'JetBrains Mono', monospace;
      --font-hdr: 'Syncopate', sans-serif;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    body, html {
      height: 100vh; 
      width: 100vw;
      background: var(--bg); 
      color: var(--text);
      font-family: var(--font-main); 
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* SIMPLIFIED BACKGROUND - NO THREE.JS LAG */
    .bg-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      overflow: hidden;
    }

    .bg-scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
      will-change: transform;
    }

    .bg-scene.active {
      opacity: 0.7;
    }

    /* Scene 1: Simple particles */
    .scene-1 {
      background: 
        radial-gradient(circle at 20% 50%, rgba(112, 0, 255, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 242, 255, 0.2) 0%, transparent 50%),
        linear-gradient(45deg, rgba(3, 3, 5, 0.9), rgba(15, 15, 25, 0.9));
    }

    .scene-1::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 30% 40%, rgba(0, 242, 255, 0.1) 2px, transparent 3px),
        radial-gradient(circle at 70% 60%, rgba(112, 0, 255, 0.1) 2px, transparent 3px),
        radial-gradient(circle at 50% 20%, rgba(255, 75, 43, 0.1) 2px, transparent 3px),
        radial-gradient(circle at 10% 80%, rgba(0, 255, 157, 0.1) 2px, transparent 3px);
      background-size: 300px 300px, 400px 400px, 500px 500px, 350px 350px;
      animation: slowMove 30s infinite linear;
    }

    /* Scene 2: Grid */
    .scene-2 {
      background: 
        linear-gradient(90deg, transparent 49%, rgba(0, 242, 255, 0.1) 50%, transparent 51%),
        linear-gradient(transparent 49%, rgba(0, 242, 255, 0.1) 50%, transparent 51%),
        linear-gradient(45deg, rgba(3, 3, 5, 0.9), rgba(15, 15, 25, 0.9));
      background-size: 40px 40px, 40px 40px, auto;
      animation: gridMove 20s infinite linear;
    }

    /* Scene 3: Wave pattern */
    .scene-3 {
      background: 
        radial-gradient(circle at center, rgba(255, 75, 43, 0.1) 0%, transparent 50%),
        linear-gradient(45deg, rgba(3, 3, 5, 0.9), rgba(15, 15, 25, 0.9));
    }

    .scene-3::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(255, 75, 43, 0.05) 3px,
          rgba(255, 75, 43, 0.05) 5px,
          transparent 6px
        );
      animation: waveMove 15s infinite linear;
    }

    /* Scene 4: Stars */
    .scene-4 {
      background: 
        radial-gradient(circle at 60% 30%, rgba(0, 255, 157, 0.1) 0%, transparent 40%),
        linear-gradient(45deg, rgba(3, 3, 5, 0.9), rgba(15, 15, 25, 0.9));
    }

    .scene-4::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 30%, white 1px, transparent 2px),
        radial-gradient(circle at 40% 70%, white 1px, transparent 2px),
        radial-gradient(circle at 60% 20%, white 1px, transparent 2px),
        radial-gradient(circle at 80% 50%, white 1px, transparent 2px),
        radial-gradient(circle at 30% 80%, white 1px, transparent 2px),
        radial-gradient(circle at 70% 90%, white 1px, transparent 2px),
        radial-gradient(circle at 90% 10%, white 1px, transparent 2px),
        radial-gradient(circle at 10% 60%, white 1px, transparent 2px);
      background-size: 100% 100%;
      animation: twinkle 4s infinite alternate;
    }

    /* Scene 5: Circles */
    .scene-5 {
      background: 
        radial-gradient(circle at 20% 20%, rgba(0, 242, 255, 0.15) 0%, transparent 30%),
        radial-gradient(circle at 80% 80%, rgba(112, 0, 255, 0.15) 0%, transparent 30%),
        radial-gradient(circle at 50% 50%, rgba(255, 75, 43, 0.1) 0%, transparent 40%),
        linear-gradient(45deg, rgba(3, 3, 5, 0.9), rgba(15, 15, 25, 0.9));
    }

    .scene-5::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 80%;
      border: 1px solid rgba(0, 242, 255, 0.1);
      border-radius: 50%;
      animation: pulseRing 8s infinite ease-in-out;
    }

    .scene-5::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      height: 60%;
      border: 1px solid rgba(112, 0, 255, 0.1);
      border-radius: 50%;
      animation: pulseRing 12s infinite ease-in-out reverse;
    }

    @keyframes slowMove {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-10px, 10px); }
      50% { transform: translate(-20px, 0); }
      75% { transform: translate(-10px, -10px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes gridMove {
      0% { background-position: 0 0, 0 0; }
      100% { background-position: 40px 40px, 40px 40px; }
    }

    @keyframes waveMove {
      0% { transform: translateY(0); }
      100% { transform: translateY(20px); }
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    @keyframes pulseRing {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.6; }
    }

    /* --- LOGIN UI (Same as before but optimized) --- */
    #login-overlay {
      position: fixed; 
      inset: 0; 
      z-index: 100;
      display: flex; 
      align-items: center; 
      justify-content: center;
      background: rgba(0, 0, 0, 0.95); 
      backdrop-filter: blur(20px);
      transition: opacity 0.8s ease;
    }

    .login-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .glitch {
      font-family: var(--font-hdr);
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 700;
      text-transform: uppercase;
      position: relative;
      color: var(--primary);
      letter-spacing: clamp(5px, 2vw, 10px);
    }

    .subtitle {
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      letter-spacing: 3px;
      opacity: 0.7;
      margin-top: 10px;
      color: var(--accent);
    }

    .login-card {
      width: min(95%, 400px); 
      padding: 30px;
      background: rgba(10, 10, 20, 0.8);
      border: 1px solid var(--border);
      border-radius: 20px; 
      text-align: center;
      backdrop-filter: blur(10px);
      position: relative;
    }

    .input-group { 
      position: relative; 
      margin: 25px 0; 
    }

    .input-group input {
      width: 100%; 
      background: rgba(255, 255, 255, 0.05); 
      border: 1px solid transparent;
      padding: 15px 20px; 
      border-radius: 10px; 
      color: #fff; 
      font-family: var(--font-main);
      transition: all 0.3s;
      font-size: 16px;
    }

    .input-group input:focus { 
      border-color: var(--primary); 
      box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
      outline: none;
    }

    .btn-primary {
      width: 100%; 
      padding: 15px; 
      border: none; 
      border-radius: 10px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: #000; 
      font-weight: 800; 
      cursor: pointer;
      text-transform: uppercase; 
      letter-spacing: 2px; 
      transition: all 0.3s;
    }

    /* --- MAIN APP --- */
    #app-container {
      position: relative; 
      z-index: 10;
      width: 100%; 
      height: 100vh;
      display: none; 
      flex-direction: column;
      margin: 0 auto;
    }

    header {
      padding: 15px 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      background: rgba(3, 3, 5, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .logo { 
      font-family: var(--font-hdr); 
      font-weight: 700; 
      font-size: clamp(1rem, 3vw, 1.2rem);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo span { 
      color: var(--primary);
    }

    /* --- CHAT AREA --- */
    #chat-history {
      flex: 1; 
      overflow-y: auto; 
      padding: 15px;
      display: flex; 
      flex-direction: column; 
      gap: 15px;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }

    #chat-history::-webkit-scrollbar { 
      display: none; 
    }

    /* Message bubbles */
    .msg {
      max-width: 85%; 
      display: flex; 
      flex-direction: column;
      animation: msgIn 0.3s ease-out;
    }

    .msg.self { 
      align-self: flex-end; 
      align-items: flex-end; 
    }

    .msg-user { 
      font-size: 0.7rem; 
      font-weight: 800; 
      margin-bottom: 4px; 
      color: var(--primary); 
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--accent));
    }

    .msg-bubble {
      padding: 12px 16px; 
      border-radius: 18px;
      background: var(--glass); 
      border: 1px solid var(--border);
      backdrop-filter: blur(10px); 
      font-size: 0.9rem; 
      line-height: 1.4;
      word-break: break-word;
    }

    .msg.self .msg-bubble {
      background: linear-gradient(135deg, var(--accent), #9000ff);
      border: none;
      border-bottom-right-radius: 4px;
      color: #fff;
    }

    .msg-time {
      font-size: 0.6rem;
      opacity: 0.5;
      margin-top: 4px;
    }

    /* --- INPUT AREA --- */
    .input-wrapper {
      padding: 15px;
      background: rgba(3, 3, 5, 0.8);
      border-top: 1px solid var(--border);
    }

    .input-bar {
      background: var(--glass); 
      border: 1px solid var(--border);
      backdrop-filter: blur(20px); 
      border-radius: 20px;
      display: flex; 
      align-items: center; 
      padding: 8px 15px; 
      gap: 10px;
    }

    #msg-input {
      flex: 1; 
      background: transparent; 
      border: none; 
      color: #fff;
      padding: 10px 0; 
      font-family: var(--font-main);
      font-size: 0.9rem;
      min-height: 40px;
      max-height: 120px;
      resize: none;
      outline: none;
    }

    .icon-btn {
      background: transparent; 
      border: none; 
      color: var(--text);
      font-size: 1.2rem; 
      cursor: pointer; 
      opacity: 0.6; 
      transition: all 0.2s;
      display: flex; 
      align-items: center;
      padding: 8px;
      border-radius: 50%;
    }

    .icon-btn:hover { 
      opacity: 1; 
      background: rgba(255, 255, 255, 0.1);
    }

    /* Animations */
    @keyframes msgIn { 
      from { opacity:0; transform: translateY(10px); } 
      to { opacity:1; transform: translateY(0); } 
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .glitch {
        font-size: 2.5rem;
      }
      
      .login-card {
        padding: 20px;
        width: 95%;
      }
      
      .msg {
        max-width: 90%;
      }
    }

    @media (max-width: 480px) {
      .glitch {
        font-size: 2rem;
      }
      
      .msg-bubble {
        padding: 10px 14px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>

  <div class="bg-container">
    <div class="bg-scene scene-1 active"></div>
    <div class="bg-scene scene-2"></div>
    <div class="bg-scene scene-3"></div>
    <div class="bg-scene scene-4"></div>
    <div class="bg-scene scene-5"></div>
  </div>

  <div id="login-overlay">
    <div class="login-container">
      <div class="login-header">
        <div class="glitch">NULLCHAT</div>
        <div class="subtitle">VOID EDITION // ENCRYPTED CONNECTION</div>
      </div>
      
      <div class="login-card">
        <div class="input-group">
          <input type="text" id="username-input" placeholder="Enter your name" autocomplete="off">
        </div>
        <button class="btn-primary" onclick="initSession()">INITIALIZE</button>
      </div>
      
      <div class="login-footer" style="margin-top: 30px; opacity: 0.5; font-size: 0.7rem;">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
          <span>üîí END-TO-END ENCRYPTED</span>
          <span>‚ö° REAL-TIME SYNC</span>
          <span>üåê P2P CONNECTED</span>
        </div>
      </div>
    </div>
  </div>

  <div id="app-container">
    <header>
      <div class="logo">
        NULL<span>CHAT</span>.v2
      </div>
      <div id="connection-status" style="font-size: 0.6rem; color: var(--success); display: flex; align-items: center; gap: 5px;">
        <i class="ri-shield-check-line"></i>
        <span>SECURE</span>
      </div>
    </header>

    <div id="chat-history"></div>

    <div class="input-wrapper">
      <form class="input-bar" onsubmit="sendMessage(event)">
        <textarea 
          id="msg-input" 
          placeholder="Type a message..." 
          autocomplete="off"
          rows="1"
          oninput="autoResize(this)"
        ></textarea>
        <button type="submit" class="icon-btn" id="send-btn" style="color: var(--primary)">
          <i class="ri-send-plane-2-fill"></i>
        </button>
      </form>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const SB_URL = 'https://lggbwtlpfbhwtzsitgmm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZ2J3dGxwZmJod3R6c2l0Z21tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjI3OTgsImV4cCI6MjA4NDQ5ODc5OH0.oD1m87laCi5vxnvWcYpN3v_BKfbDOvfll0omUORzEW4';
    const db = supabase.createClient(SB_URL, SB_KEY);

    let user = null;
    let username = "";
    let currentScene = 0;
    let sceneInterval = null;
    let messageMap = new Map();

    // --- SIMPLE BACKGROUND ROTATION ---
    function initBackgrounds() {
      const scenes = document.querySelectorAll('.bg-scene');
      
      // Start with first scene active
      scenes[0].classList.add('active');
      
      // Rotate every 15 seconds
      sceneInterval = setInterval(() => {
        scenes[currentScene].classList.remove('active');
        currentScene = (currentScene + 1) % scenes.length;
        scenes[currentScene].classList.add('active');
      }, 15000);
    }

    // --- SESSION MANAGEMENT ---
    async function initSession() {
      username = document.getElementById('username-input').value.trim();
      if(!username) {
        alert("Please enter a name");
        return;
      }

      const btn = document.querySelector('.btn-primary');
      btn.innerHTML = '<i class="ri-loader-4-line spin"></i> INITIALIZING';
      btn.disabled = true;

      const { data, error } = await db.auth.signInAnonymously();
      if(error) {
        alert("Connection error. Please try again.");
        btn.innerHTML = 'INITIALIZE';
        btn.disabled = false;
        return;
      }
      
      user = data.user;
      
      // Create or update profile
      await db.from('profiles').upsert({ 
        id: user.id, 
        username: username, 
        updated_at: new Date() 
      });

      // Animated transition
      const loginOverlay = document.getElementById('login-overlay');
      loginOverlay.style.opacity = '0';
      
      setTimeout(() => {
        loginOverlay.style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        
        // Start background rotation
        initBackgrounds();
        
        // Load chat
        loadHistory();
        subscribeToChat();
        
        // Welcome message
        setTimeout(() => {
          addSystemMessage("Welcome to NULLCHAT, " + username + "!");
        }, 500);
        
      }, 800);
    }

    // --- MESSAGE HANDLING ---
    function sendMessage(e) {
      e.preventDefault();
      const input = document.getElementById('msg-input');
      const content = input.value.trim();
      
      if (!content) return;
      
      // Create message object
      const message = {
        id: 'temp_' + Date.now(),
        user_id: user.id,
        content: content,
        profiles: { username: username },
        created_at: new Date(),
        status: 'sending'
      };
      
      // Show message instantly
      appendMsg(message, true);
      scrollBottom();
      
      // Clear input
      input.value = '';
      input.style.height = 'auto';
      
      // Send to server
      sendToServer(message);
    }

    async function sendToServer(message) {
      try {
        const { data, error } = await db.from('messages').insert({
          user_id: user.id,
          content: message.content
        }).select(`
          *,
          profiles(username)
        `).single();

        if (error) throw error;

        // Update message with real ID
        updateMessageStatus(message.id, data.id);

      } catch (error) {
        console.error('Error sending message:', error);
        updateMessageStatus(message.id, 'error');
      }
    }

    // --- MESSAGE DISPLAY ---
    function appendMsg(msg, isSelf = false) {
      const history = document.getElementById('chat-history');
      
      const div = document.createElement('div');
      div.className = `msg ${isSelf ? 'self' : ''}`;
      div.id = `msg-${msg.id}`;
      div.dataset.messageId = msg.id;
      
      // Store in message map
      messageMap.set(msg.id, msg);
      
      // Format timestamp
      const timestamp = new Date(msg.created_at).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
      });

      div.innerHTML = `
        <span class="msg-user">
          <div class="user-avatar"></div>
          ${isSelf ? 'YOU' : (msg.profiles?.username || 'User')}
        </span>
        <div class="msg-bubble">
          ${msg.content}
        </div>
        <div class="msg-time">${timestamp}</div>
      `;
      
      history.appendChild(div);
    }

    function addSystemMessage(content) {
      const history = document.getElementById('chat-history');
      const div = document.createElement('div');
      div.className = 'msg';
      div.style.alignSelf = 'center';
      div.style.opacity = '0.6';
      div.innerHTML = `
        <div class="msg-bubble" style="background: rgba(112, 0, 255, 0.2); border: 1px solid rgba(112, 0, 255, 0.3);">
          ${content}
        </div>
      `;
      history.appendChild(div);
      scrollBottom();
    }

    function updateMessageStatus(tempId, newId) {
      const element = document.getElementById(`msg-${tempId}`);
      if (element && newId !== 'error') {
        element.id = `msg-${newId}`;
        element.dataset.messageId = newId;
      } else if (newId === 'error') {
        element.style.opacity = '0.5';
        element.querySelector('.msg-bubble').style.borderColor = 'var(--danger)';
      }
    }

    // --- CHAT SUBSCRIPTIONS ---
    async function loadHistory() {
      const { data } = await db.from('messages')
        .select(`
          *,
          profiles(username)
        `)
        .order('created_at', { ascending: false })
        .limit(50);
      
      if(data) {
        data.reverse().forEach(msg => {
          // Don't show our own optimistic messages
          if (!document.getElementById(`msg-${msg.id}`)) {
            appendMsg(msg, msg.user_id === user.id);
          }
        });
        scrollBottom();
      }
    }

    function subscribeToChat() {
      db.channel('public:messages')
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'messages' 
        }, async (payload) => {
          // Don't show our own messages (they're already shown optimistically)
          if(payload.new.user_id !== user.id) {
            const { data: prof } = await db.from('profiles')
              .select('username')
              .eq('id', payload.new.user_id)
              .single();
            
            const msgWithProfile = { 
              ...payload.new, 
              profiles: prof 
            };
            
            if (!document.getElementById(`msg-${payload.new.id}`)) {
              appendMsg(msgWithProfile, false);
              scrollBottom();
            }
          }
        })
        .subscribe();
    }

    // --- UTILITY FUNCTIONS ---
    function scrollBottom() {
      const h = document.getElementById('chat-history');
      setTimeout(() => {
        h.scrollTop = h.scrollHeight;
      }, 100);
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Add spin animation
    const style = document.createElement('style');
    style.textContent = `
      .spin {
        display: inline-block;
        animation: rotate 1s linear infinite;
      }
      @keyframes rotate {
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);

    // Initialize on load
    window.addEventListener('load', () => {
      const usernameInput = document.getElementById('username-input');
      usernameInput.focus();
    });

    // Handle Enter key for sending
    document.getElementById('msg-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.querySelector('.input-bar').requestSubmit();
      }
    });
  </script>
</body>
</html>