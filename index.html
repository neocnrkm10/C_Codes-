<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NULLCHAT // ULTIMATE</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Syncopate:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #00f0ff;
      --secondary: #7000ff;
      --accent: #ff0055;
      --bg-dark: #050508;
      --glass: rgba(20, 20, 30, 0.6);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text: #e0e0e0;
      --font-main: 'Space Grotesk', sans-serif;
      --font-head: 'Syncopate', sans-serif;
    }

    /* --- RESET & BASE --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      background: var(--bg-dark);
      color: var(--text);
      font-family: var(--font-main);
      height: 100vh; width: 100vw;
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* --- DYNAMIC BACKGROUNDS (CSS ONLY = NO LAG) --- */
    #bg-layer {
      position: fixed; inset: 0; z-index: -1;
      transition: opacity 2s ease;
    }
    
    /* Theme 1: Cyber Grid */
    .theme-grid {
      background: 
        linear-gradient(rgba(0, 240, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.05) 1px, transparent 1px),
        radial-gradient(circle at center, #0a0a12 0%, #000 100%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
      animation: panGrid 60s linear infinite;
    }
    
    /* Theme 2: Nebula Pulse */
    .theme-nebula {
      background: 
        radial-gradient(circle at 20% 30%, rgba(112, 0, 255, 0.15), transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(255, 0, 85, 0.1), transparent 40%),
        #050508;
      animation: pulseNebula 10s ease-in-out infinite alternate;
    }
    
    /* Theme 3: Digital Rain (Simplified) */
    .theme-rain {
      background: linear-gradient(180deg, #050508 0%, #0a0a15 100%);
    }
    .theme-rain::before {
      content: ''; position: absolute; inset: 0;
      background-image: linear-gradient(0deg, transparent 24%, rgba(0, 255, 0, .03) 25%, rgba(0, 255, 0, .03) 26%, transparent 27%, transparent 74%, rgba(0, 255, 0, .03) 75%, rgba(0, 255, 0, .03) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(0, 255, 0, .03) 25%, rgba(0, 255, 0, .03) 26%, transparent 27%, transparent 74%, rgba(0, 255, 0, .03) 75%, rgba(0, 255, 0, .03) 76%, transparent 77%, transparent);
      background-size: 50px 50px;
    }

    @keyframes panGrid { 0% { background-position: 0 0, 0 0, center; } 100% { background-position: 40px 40px, 40px 40px, center; } }
    @keyframes pulseNebula { 0% { opacity: 0.8; } 100% { opacity: 1; filter: hue-rotate(20deg); } }

    /* --- UI LAYOUT --- */
    header {
      padding: 15px 20px;
      background: rgba(5, 5, 8, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
    }
    .brand { font-family: var(--font-head); font-size: 1.2rem; letter-spacing: 2px; }
    .brand span { color: var(--primary); }

    /* CHAT AREA */
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15px;
      display: flex; flex-direction: column; gap: 20px;
      scroll-behavior: smooth;
    }
    /* Hide scrollbar */
    #chat-container::-webkit-scrollbar { width: 4px; }
    #chat-container::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }

    /* MESSAGE BUBBLES */
    .msg-group { display: flex; flex-direction: column; max-width: 85%; position: relative; }
    .msg-group.self { align-self: flex-end; align-items: flex-end; }
    
    .msg-sender { font-size: 0.75rem; color: var(--primary); margin-bottom: 4px; font-weight: 700; opacity: 0.8; }
    
    .msg-bubble {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      padding: 12px 16px;
      border-radius: 16px;
      border-top-left-radius: 2px;
      position: relative;
      transition: background 0.2s;
    }
    .self .msg-bubble {
      background: linear-gradient(135deg, rgba(112, 0, 255, 0.4), rgba(0, 0, 0, 0));
      border-color: rgba(112, 0, 255, 0.3);
      border-radius: 16px;
      border-top-right-radius: 2px;
    }

    /* Reply Context inside Bubble */
    .reply-context {
      font-size: 0.75rem;
      border-left: 2px solid var(--accent);
      padding-left: 8px;
      margin-bottom: 8px;
      opacity: 0.7;
      background: rgba(0,0,0,0.2);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Attachments */
    .msg-img { max-width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid var(--glass-border); cursor: pointer;}
    .msg-audio { width: 200px; height: 32px; margin-top: 5px; }

    /* Reactions Grid */
    .reactions-display {
      display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;
    }
    .reaction-pill {
      font-size: 0.7rem; background: rgba(255,255,255,0.05);
      padding: 2px 6px; border-radius: 10px; border: 1px solid transparent;
    }
    .reaction-pill.active { border-color: var(--primary); background: rgba(0, 240, 255, 0.1); }

    /* --- INPUT AREA --- */
    .input-zone {
      padding: 10px 15px;
      background: rgba(5, 5, 8, 0.95);
      border-top: 1px solid var(--glass-border);
    }
    
    /* Reply Preview Bar */
    #reply-bar {
      display: none;
      background: rgba(112, 0, 255, 0.1);
      border-left: 3px solid var(--primary);
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .input-wrapper {
      display: flex; align-items: flex-end; gap: 10px;
      background: rgba(255,255,255,0.03);
      border-radius: 24px;
      padding: 8px 12px;
      border: 1px solid var(--glass-border);
    }

    #msg-input {
      flex: 1; background: transparent; border: none; color: #fff;
      font-family: var(--font-main); font-size: 1rem;
      max-height: 100px; min-height: 24px;
      resize: none; outline: none; padding: 4px 0;
    }

    .action-btn {
      color: var(--text); background: transparent; border: none;
      font-size: 1.2rem; padding: 6px; cursor: pointer;
      opacity: 0.7; transition: 0.2s; border-radius: 50%;
    }
    .action-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
    .send-btn { color: var(--primary); opacity: 1; }
    .record-btn.recording { color: var(--accent); animation: pulseRed 1s infinite; }

    @keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* --- CONTEXT MENU (Long Press) --- */
    #context-menu {
      position: fixed; display: none; z-index: 1000;
      background: rgba(15, 15, 20, 0.95);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      min-width: 180px; overflow: hidden;
      animation: menuPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .ctx-item {
      padding: 12px 16px; display: flex; align-items: center; gap: 10px;
      cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.9rem;
    }
    .ctx-item:active { background: rgba(255,255,255,0.1); }
    .ctx-reactions { padding: 10px; display: flex; justify-content: space-around; background: rgba(0,0,0,0.2); }
    .ctx-emoji { font-size: 1.4rem; cursor: pointer; transition: transform 0.1s; }
    .ctx-emoji:active { transform: scale(1.4); }

    @keyframes menuPop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

    /* --- LOGIN OVERLAY --- */
    #login-screen {
      position: fixed; inset: 0; z-index: 200;
      background: #000;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
    }
    .glitch-text { font-family: var(--font-head); font-size: 2.5rem; color: var(--primary); margin-bottom: 20px; }
    .login-box { display: flex; gap: 10px; }
    .login-input { 
      padding: 10px 15px; background: #111; border: 1px solid #333; 
      color: #fff; border-radius: 8px; outline: none; 
    }
    .login-btn { 
      padding: 10px 20px; background: var(--primary); color: #000; 
      border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
    }

    /* HIDDEN ELEMENTS */
    input[type="file"] { display: none; }
  </style>
</head>
<body>

  <div id="bg-layer" class="theme-grid"></div>

  <div id="login-screen">
    <div class="glitch-text">NULLCHAT</div>
    <div class="login-box">
      <input type="text" id="username" class="login-input" placeholder="Codename..." autocomplete="off">
      <button class="login-btn" onclick="joinChat()">ENTER VOID</button>
    </div>
  </div>

  <header>
    <div class="brand">NULL<span>CHAT</span></div>
    <div style="font-size: 0.8rem; opacity: 0.7;" id="status-indicator">OFFLINE</div>
  </header>

  <div id="chat-container">
    </div>

  <div class="input-zone">
    <div id="reply-bar">
      <span>Replying to <b id="reply-to-user">User</b></span>
      <i class="ri-close-line" onclick="cancelReply()" style="cursor:pointer"></i>
    </div>

    <div class="input-wrapper">
      <input type="file" id="file-input" accept="image/*">
      <button class="action-btn" onclick="document.getElementById('file-input').click()">
        <i class="ri-image-add-line"></i>
      </button>
      
      <button class="action-btn record-btn" id="mic-btn">
        <i class="ri-mic-2-line"></i>
      </button>

      <textarea id="msg-input" rows="1" placeholder="Broadcast to the void..."></textarea>
      
      <button class="action-btn send-btn" onclick="sendMessage()">
        <i class="ri-send-plane-2-fill"></i>
      </button>
    </div>
  </div>

  <div id="context-menu">
    <div class="ctx-reactions">
      <span class="ctx-emoji" onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="ctx-emoji" onclick="react('üòÇ')">üòÇ</span>
      <span class="ctx-emoji" onclick="react('üî•')">üî•</span>
      <span class="ctx-emoji" onclick="react('üëç')">üëç</span>
      <span class="ctx-emoji" onclick="react('üíÄ')">üíÄ</span>
    </div>
    <div class="ctx-item" onclick="initReply()">
      <i class="ri-reply-line"></i> Reply
    </div>
    <div class="ctx-item" onclick="copyText()">
      <i class="ri-file-copy-line"></i> Copy Text
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SB_URL = 'https://lggbwtlpfbhwtzsitgmm.supabase.co'; // YOUR SUPABASE URL
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZ2J3dGxwZmJod3R6c2l0Z21tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjI3OTgsImV4cCI6MjA4NDQ5ODc5OH0.oD1m87laCi5vxnvWcYpN3v_BKfbDOvfll0omUORzEW4'; // YOUR ANON KEY
    const BUCKET = 'chat-files'; // Ensure this bucket exists and is public
    
    const db = supabase.createClient(SB_URL, SB_KEY);

    // --- STATE ---
    let currentUser = null;
    let currentProfile = null;
    let replyTo = null; // { id, username, text }
    let selectedMsgId = null; // For context menu
    let mediaRecorder = null;
    let audioChunks = [];
    
    // --- BACKGROUND MANAGER ---
    const themes = ['theme-grid', 'theme-nebula', 'theme-rain'];
    let themeIdx = 0;
    
    setInterval(() => {
      const bg = document.getElementById('bg-layer');
      bg.style.opacity = 0; // Fade out
      setTimeout(() => {
        bg.classList.remove(...themes);
        themeIdx = (themeIdx + 1) % themes.length;
        bg.classList.add(themes[themeIdx]);
        bg.style.opacity = 1; // Fade in
      }, 2000);
    }, 45000); // Change every 45 seconds

    // --- AUTH ---
    async function joinChat() {
      const username = document.getElementById('username').value.trim();
      if (!username) return alert("Identify yourself.");

      const btn = document.querySelector('.login-btn');
      btn.textContent = "CONNECTING...";
      
      // Anon Auth
      const { data: authData, error } = await db.auth.signInAnonymously();
      if (error) return alert("Connection failed.");

      currentUser = authData.user;
      
      // Update Profile
      await db.from('profiles').upsert({ id: currentUser.id, username: username });
      currentProfile = { id: currentUser.id, username };

      // UI Transition
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('status-indicator').innerHTML = '<span style="color:#00ff9d">‚óè ONLINE</span>';
      
      loadMessages();
      subscribeRealtime();
    }

    // --- MESSAGING LOGIC ---
    async function loadMessages() {
      // Get Messages + Profile info + Reactions
      const { data, error } = await db.from('messages')
        .select(`
          *,
          profiles(username),
          reactions(emoji, user_id),
          reply_parent:messages!reply_to_id(content, profiles(username))
        `)
        .order('created_at', { ascending: false })
        .limit(50);

      if (data) {
        document.getElementById('chat-container').innerHTML = '';
        data.reverse().forEach(renderMessage);
        scrollToBottom();
      }
    }

    // --- REALTIME ---
    function subscribeRealtime() {
      db.channel('public:chat')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
          // Fetch full details for the new message
          const { data } = await db.from('messages')
            .select(`*, profiles(username), reactions(emoji, user_id), reply_parent:messages!reply_to_id(content, profiles(username))`)
            .eq('id', payload.new.id)
            .single();
          if (data) {
            renderMessage(data);
            scrollToBottom();
          }
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'reactions' }, () => {
          // Simplistic approach: Reload for reactions to ensure sync
          // Optimally, we would update just the DOM node, but reload is safer for integrity here
          loadMessages(); 
        })
        .subscribe();
    }

    // --- RENDERER ---
    function renderMessage(msg) {
      const container = document.getElementById('chat-container');
      const isSelf = msg.user_id === currentUser.id;
      
      const div = document.createElement('div');
      div.className = `msg-group ${isSelf ? 'self' : ''}`;
      div.id = `msg-${msg.id}`;
      div.dataset.content = msg.content || "";
      div.dataset.username = msg.profiles?.username || "Unknown";

      // Context Menu Event Listener
      div.addEventListener('contextmenu', (e) => showContextMenu(e, msg.id));
      // Mobile Long Press
      let pressTimer;
      div.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => showContextMenu(e, msg.id, true), 600);
      });
      div.addEventListener('touchend', () => clearTimeout(pressTimer));

      // Build Content
      let contentHtml = '';
      
      // Reply Header
      if (msg.reply_parent) {
        contentHtml += `
          <div class="reply-context">
            <small style="color:var(--primary)">@${msg.reply_parent.profiles?.username || 'User'}</small><br>
            ${msg.reply_parent.content ? msg.reply_parent.content.substring(0,30) + '...' : 'Attachment'}
          </div>`;
      }

      // Text
      if (msg.content) {
        contentHtml += `<span>${escapeHtml(msg.content)}</span>`;
      }

      // Attachments
      if (msg.attachment_type === 'image') {
        contentHtml += `<img src="${msg.attachment_url}" class="msg-img" onclick="window.open(this.src)">`;
      } else if (msg.attachment_type === 'audio') {
        contentHtml += `<audio src="${msg.attachment_url}" controls class="msg-audio"></audio>`;
      }

      // Reactions
      let reactionHtml = '';
      if (msg.reactions && msg.reactions.length > 0) {
        const counts = {};
        msg.reactions.forEach(r => { counts[r.emoji] = (counts[r.emoji] || 0) + 1; });
        
        reactionHtml = `<div class="reactions-display">`;
        for (const [emoji, count] of Object.entries(counts)) {
          reactionHtml += `<span class="reaction-pill">${emoji} ${count}</span>`;
        }
        reactionHtml += `</div>`;
      }

      div.innerHTML = `
        <div class="msg-sender">${isSelf ? '' : (msg.profiles?.username || 'User')}</div>
        <div class="msg-bubble">
          ${contentHtml}
        </div>
        ${reactionHtml}
      `;

      container.appendChild(div);
    }

    // --- SENDING MESSAGES ---
    async function sendMessage(attachmentUrl = null, type = 'none') {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();

      if (!text && !attachmentUrl) return;

      const payload = {
        user_id: currentUser.id,
        content: text || null,
        attachment_url: attachmentUrl,
        attachment_type: type,
        reply_to_id: replyTo ? replyTo.id : null
      };

      // Reset UI immediately
      input.value = '';
      cancelReply();
      
      const { error } = await db.from('messages').insert(payload);
      if (error) console.error("Send failed", error);
    }

    // --- FILE UPLOAD ---
    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadAndSend(file, 'image');
    });

    // --- VOICE RECORDER ---
    const micBtn = document.getElementById('mic-btn');
    micBtn.addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        // Start Recording
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioFile = new File([audioBlob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
            uploadAndSend(audioFile, 'audio');
            micBtn.classList.remove('recording');
          };
          
          mediaRecorder.start();
          micBtn.classList.add('recording');
        } catch (err) { alert("Microphone access denied."); }
      } else {
        // Stop Recording
        mediaRecorder.stop();
      }
    });

    async function uploadAndSend(file, type) {
      // 1. Upload to Storage
      const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;
      const { data, error } = await db.storage.from(BUCKET).upload(fileName, file);
      
      if (error) {
        alert("Upload failed. Make sure bucket exists and is public.");
        return;
      }

      // 2. Get URL
      const { data: { publicUrl } } = db.storage.from(BUCKET).getPublicUrl(fileName);
      
      // 3. Send Message
      sendMessage(publicUrl, type);
    }

    // --- CONTEXT MENU ACTIONS ---
    function showContextMenu(e, msgId, isTouch = false) {
      e.preventDefault();
      selectedMsgId = msgId;
      const menu = document.getElementById('context-menu');
      
      // Position logic
      let x = isTouch ? e.touches[0].clientX : e.clientX;
      let y = isTouch ? e.touches[0].clientY : e.clientY;
      
      // Keep within bounds
      if (x + 200 > window.innerWidth) x = window.innerWidth - 210;
      if (y + 150 > window.innerHeight) y = window.innerHeight - 160;

      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
      menu.style.display = 'block';
      
      // Close on click outside
      const closeMenu = () => {
        menu.style.display = 'none';
        document.removeEventListener('click', closeMenu);
      };
      setTimeout(() => document.addEventListener('click', closeMenu), 100);
    }

    async function react(emoji) {
      if (!selectedMsgId) return;
      // Delete existing reaction from this user on this message first (toggle logic) or just insert
      // For simplicity: Insert, ignore conflict
      await db.from('reactions').insert({
        message_id: selectedMsgId,
        user_id: currentUser.id,
        emoji: emoji
      }).select();
      // If error (unique constraint), maybe delete it? (Toggle)
      // Implementation choice: Simple add for now.
    }

    function initReply() {
      const el = document.getElementById(`msg-${selectedMsgId}`);
      if (!el) return;
      
      replyTo = {
        id: selectedMsgId,
        username: el.dataset.username,
        text: el.dataset.content
      };
      
      document.getElementById('reply-to-user').innerText = replyTo.username;
      document.getElementById('reply-bar').style.display = 'flex';
      document.getElementById('msg-input').focus();
    }

    function cancelReply() {
      replyTo = null;
      document.getElementById('reply-bar').style.display = 'none';
    }

    function copyText() {
      const el = document.getElementById(`msg-${selectedMsgId}`);
      if (el && el.dataset.content) {
        navigator.clipboard.writeText(el.dataset.content);
        alert("Copied to clipboard");
      }
    }

    // --- UTILS ---
    function escapeHtml(text) {
      if (!text) return text;
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function scrollToBottom() {
      const container = document.getElementById('chat-container');
      setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
    }
    
    // Auto-resize textarea
    const tx = document.getElementById('msg-input');
    tx.addEventListener("input", () => {
      tx.style.height = 'auto';
      tx.style.height = (tx.scrollHeight) + "px";
    });

  </script>
</body>
</html>
